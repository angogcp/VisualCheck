<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC-Check 02 | 画像検査ステーション</title>
    <meta name="description" content="特殊ケーブル製造 AI画像検査 キャプチャステーション">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <!-- ── ナビゲーション ── -->
    <nav class="main-nav">
        <div class="nav-inner">
            <div class="nav-brand">
                <div class="logo-mark-sm">QC</div>
                <span class="nav-title">QC-Check 02</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link {% if active_page == 'capture' %}active{% endif %}">
                    <span class="nav-icon">📷</span>
                    <span>キャプチャ</span>
                </a>
                <a href="/gallery-page" class="nav-link {% if active_page == 'gallery' %}active{% endif %}">
                    <span class="nav-icon">🖼️</span>
                    <span>ギャラリー</span>
                </a>
                <a href="/reports" class="nav-link {% if active_page == 'reports' %}active{% endif %}">
                    <span class="nav-icon">📊</span>
                    <span>レポート</span>
                </a>
            </div>
            <div class="nav-actions">
                <button onclick="openSpecAnalysis()" class="nav-btn" title="設計書解析"
                    style="margin-right:0.5rem; background:rgba(0,0,0,0.3); border:1px solid var(--border-glass);">
                    <span>📋</span> 解析・見積
                </button>
                <a href="/export" class="nav-btn" title="CSVダウンロード">
                    <span>📥</span> エクスポート
                </a>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- トースト通知 -->
    <div id="toast-container"></div>

    <!-- ── 共通画像ビューアモーダル ── -->
    <div class="viewer-overlay" id="viewer-overlay" onclick="closeViewer()">
        <div class="viewer-container" onclick="event.stopPropagation()">
            <button class="viewer-close" onclick="closeViewer()" title="閉じる (Esc)">✕</button>
            <button class="viewer-nav viewer-prev" onclick="viewerNavigate(-1)" title="前の画像 (←)">‹</button>
            <div class="viewer-image-wrap">
                <img id="viewer-image" src="" alt="プレビュー">
                <img id="viewer-heatmap" src="" alt="ヒートマップ" class="heatmap-overlay" style="display:none; opacity:0.6;">
            </div>
            <button class="viewer-nav viewer-next" onclick="viewerNavigate(1)" title="次の画像 (→)">›</button>
            <div class="viewer-footer">
                <div class="viewer-info">
                    <span class="viewer-label" id="viewer-label"></span>
                    <span class="viewer-filename" id="viewer-filename"></span>
                    <span class="viewer-counter" id="viewer-counter"></span>
                </div>

                <!-- AI連携 -->
                <div class="viewer-ai-section" style="margin: 0 1rem; display:flex; gap:0.5rem; align-items:center;">
                    <button id="btn-analyze" class="btn btn-analyze"
                        style="background:#5c6bc0; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">🤖
                        AI判定</button>
                    <button id="btn-heatmap" class="btn btn-analyze"
                        style="background:#ef5350; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; display:none;"
                        onclick="toggleHeatmap()">🔥 ヒートマップ</button>
                    <div id="ai-result-container" class="ai-result"
                        style="display:none; margin-left:0.5rem; align-items:center; gap:0.5rem;">
                        <span id="ai-label-value" class="ai-label-pill"
                            style="padding:0.25rem 0.5rem; border-radius:4px; font-weight:bold;"></span>
                        <span id="ai-score-value" class="ai-score-text"
                            style="font-family:monospace; font-weight:bold;"></span>
                    </div>
                </div>

                <div class="viewer-actions">
                    <button class="btn btn-viewer-ok" onclick="viewerLabel('ok')">
                        <span>✓</span> OK
                    </button>
                    <button class="btn btn-viewer-ng" onclick="viewerLabel('ng')">
                        <span>✗</span> NG
                    </button>
                    <button class="btn btn-viewer-delete" onclick="viewerDelete()">
                        <span>🗑</span> 削除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── AIモデル設定モーダル ── -->
    <div class="viewer-overlay" id="model-settings-overlay" onclick="closeModelSettings()">
        <div class="glass-card" style="width: 500px; max-width:90vw; padding:0;" onclick="event.stopPropagation()">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                <h2>⚙️ AIモデル設定</h2>
                <button onclick="closeModelSettings()"
                    style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;">✕</button>
            </div>
            <div style="padding: 20px;">
                <!-- モデル選択 -->
                <div style="margin-bottom: 20px;">
                    <label
                        style="display:block; color:var(--text-secondary); margin-bottom:8px; font-size:0.9rem;">使用モデル</label>
                    <select id="model-select"
                        style="width:100%; padding: 10px; background:rgba(0,0,0,0.2); border:1px solid var(--border-glass); color:var(--text-primary); border-radius:var(--radius-sm);"
                        onchange="loadVersionList(this.value)">
                        <option value="patchcore">PatchCore (デフォルト)</option>
                        <option value="padim">PaDiM</option>
                        <option value="efficientad">EfficientAD</option>
                    </select>
                </div>

                <!-- バージョン管理 -->
                <div style="margin-bottom: 20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <label style="color:var(--text-secondary); font-size:0.9rem;">バージョン <span
                                id="current-version-badge"
                                style="background:var(--accent-blue-bg); color:var(--accent-blue); padding:2px 6px; border-radius:4px; font-size:0.75rem;">Loading...</span></label>
                    </div>

                    <div id="version-list"
                        style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.1); border-radius:var(--radius-sm); padding:10px;">
                        <!-- JSで動的生成 -->
                        <div style="text-align:center; color:var(--text-muted);">読み込み中...</div>
                    </div>
                </div>

                <!-- アクション -->
                <div
                    style="border-top:1px solid var(--border-glass); margin-top:20px; padding-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button onclick="startTraining()" class="btn"
                        style="background:var(--accent-blue-bg); color:var(--accent-blue); border:1px solid var(--accent-blue);">
                        🔄 学習開始
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── 設計書解析モーダル ── -->
    <div class="viewer-overlay" id="spec-analysis-overlay" onclick="closeSpecAnalysis()">
        <div class="glass-card"
            style="width: 800px; max-width:95vw; padding:0; height:85vh; display:flex; flex-direction:column;"
            onclick="event.stopPropagation()">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                <h2>📋 設計書解析 & コスト試算</h2>
                <button onclick="closeSpecAnalysis()"
                    style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;">✕</button>
            </div>

            <div style="flex:1; overflow-y:auto; padding:20px; display:flex; gap:20px; flex-direction:column;">
                <!-- Capture Area -->
                <div style="display:flex; gap:20px; align-items:center;">
                    <button id="btn-capture-spec" onclick="captureSpecImage()" class="btn btn-capture" style="flex:1;">
                        📷 カメラで撮影
                    </button>
                    <!-- File Upload Option -->
                    <div style="flex:1; display:flex; gap:10px; align-items:center;">
                        <input type="file" id="spec-file-upload" accept="image/*" style="display:none;"
                            onchange="handleSpecFileUpload(event)">
                        <button onclick="document.getElementById('spec-file-upload').click()" class="btn btn-secondary"
                            style="flex:1; border:1px solid var(--border-glass);">
                            📁 画像をアップロード
                        </button>
                    </div>
                </div>

                <div id="spec-results" style="display:none; flex:1;">
                    <div style="display:flex; gap:20px; margin-bottom:20px;">
                        <img id="spec-capture-preview"
                            style="height:150px; border-radius:8px; border:1px solid var(--border-glass);">
                        <div style="flex:1;">
                            <div
                                style="font-size:1.2rem; font-weight:bold; color:var(--text-primary); margin-bottom:10px;">
                                概算見積: <span id="spec-total-cost" style="color:var(--accent-ok);">---</span>
                            </div>
                            <p style="color:var(--text-muted); font-size:0.9rem;">
                                自動識別されたコンポーネントに基づきます。数量や名称は編集可能です。
                            </p>
                        </div>
                    </div>

                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr
                                style="text-align:left; color:var(--text-secondary); border-bottom:1px solid var(--border-glass);">
                                <th style="padding:10px;">型番 (P/N)</th>
                                <th style="padding:10px;">コンポーネント</th>
                                <th style="padding:10px;">詳細</th>
                                <th style="padding:10px;">数量</th>
                            </tr>
                        </thead>
                        <tbody id="spec-components-body">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/viewer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/models.js') }}"></script>
    <script src="{{ url_for('static', filename='js/spec_analysis.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>

</html>